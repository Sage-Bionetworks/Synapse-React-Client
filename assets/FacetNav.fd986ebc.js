import{E as ee,f as ae,V as Y,C as te,ct as ne,I as re}from"./index.6ac6fc35.js";import{d as Q,e as z,S as oe,E as G,h as U,i as $,T as le,j as se,k as ie}from"./TotalQueryResults.9688f412.js";import{j as a,F as I,a as C}from"./jsx-runtime.00d70968.js";import{a as ce}from"./queryUtils.6a2e997c.js";import{c as de,P as ue}from"./factory.29907778.js";import{r as pe}from"./react-sizeme.4b0d4f6e.js";import{g as me}from"./ColorGradient.16f0e0f2.js";import{E as D,u as fe}from"./ElementWithTooltip.818590d5.js";import{C as V}from"./ColumnType.744125d2.js";import"./assert.28421ae9.js";import{l as he}from"./LoadingScreen.b468edab.js";import{d as ye}from"./Tooltip.006e7cf4.js";import{M as A}from"./Modal.ec8bc390.js";import{B as j}from"./Button.fda23eee.js";import{I as _e}from"./InfoOutlined.31277c73.js";import{D as L}from"./Dropdown.13d94a98.js";const O=()=>{const{error:e}=Q();return a(ee,{error:e})};try{O.displayName="QueryWrapperErrorBanner",O.__docgenInfo={description:"Error banner that automatically pulls the error from QueryContext.",displayName:"QueryWrapperErrorBanner",props:{}},typeof STORYBOOK_REACT_CLASSES<"u"&&(STORYBOOK_REACT_CLASSES["src/lib/containers/QueryWrapperErrorBanner.tsx#QueryWrapperErrorBanner"]={docgenInfo:O.__docgenInfo,name:"QueryWrapperErrorBanner",path:"src/lib/containers/QueryWrapperErrorBanner.tsx#QueryWrapperErrorBanner"})}catch{}const ge=window.React.useCallback,Se=window.React.useEffect,W=window.React.useState,Ce=de(ue),Ne=19,Fe=30,ve={showlegend:!1,annotations:[],margin:{l:0,r:0,b:0,t:0,pad:0},yaxis:{visible:!1,showgrid:!1},xaxis:{visible:!1,showgrid:!1}},be=(e,t)=>{t=t||0;let o=(Math.round(100*e*Math.pow(10,t))*Math.pow(.1,t)).toFixed(t)+"%";for(let l=0;l<t;l++)o.indexOf(".")!==-1&&(o=o.replace("0%","%"),o=o.replace(".%","%"));return o};function X(e,t){if(!e)return e;const o=e.trim();return o.length>t?o.substr(0,t-1)+"\u2026":e}async function Ee(e,t,o,l,m){var c,T;const{colorPalette:d}=me(o,e.facetValues.length),n=async(s,p,f)=>{const _=new Map;_.set(Y,te);const E=s.map(r=>r.value).filter(r=>r!==Y);if(p===V.ENTITYID||p===V.ENTITYID_LIST){const r=await ne(E,f);for(const g of r.results)_.set(g.id,g.name)}else if(p===V.USERID||p===V.USERID_LIST){const r=await re(E,f);for(const g of r.children)_.set(g.ownerId,g.userName)}return s.map(r=>({facet:r,label:y(r,!1,_),truncatedLabel:y(r,!0,_),count:r.count}))},y=(s,p,f)=>{var E;let _=(E=f.get(s.value))!=null?E:s.value;return p&&(_=X(_,Ne)),_},N=await n(e.facetValues,t,m),v=N.map(s=>s.truncatedLabel),w=e.facetValues.some(s=>s.isSelected)?e.facetValues.map((s,p)=>s.isSelected?d[p]:d[p].replace("rgb(","rgba(").replace(")",", 0.25)")):d,b={values:l==="PIE"?e.facetValues.map(s=>s.count):void 0,labels:N.map(s=>s.label),text:v,x:l==="BAR"?e.facetValues.map(s=>{var p,f;return(f=(p=N.find(_=>_.facet===s))==null?void 0:p.label)!=null?f:s.value}):void 0,y:l==="BAR"?e.facetValues.map(s=>s.count):void 0,facetEnumerationValues:e.facetValues.map(s=>s.value),name:e.columnName,hovertemplate:l==="PIE"?"<b>%{text}</b><br>%{value} (%{percent})<br><extra></extra>":"<b>%{text}: </b><br>%{value} <br><extra></extra>",textinfo:"none",type:l==="PIE"?"pie":"bar",pull:l==="PIE"?e.facetValues.map(s=>s.isSelected?.1:0):void 0,marker:{colors:l==="PIE"?w:void 0,color:l==="BAR"?w:void 0}};return{data:[b],labels:N,colors:l==="PIE"?(c=b.marker)==null?void 0:c.colors:(T=b.marker)==null?void 0:T.color}}const we=(e,t,o)=>{if(e.points&&e.points[0]){const l=e.points[0],m=l.data.facetEnumerationValues[l.pointNumber],d=t.facetValues.find(n=>n.value===m);o(t,d,!d.isSelected)}};function xe(e,t,o){const m=e?e*(t==="BAR"?.8:.6):200;let d=t==="PIE"?m:m/3;return d>o&&(d=o),{width:`${m}px`,height:`${d}px`}}function M(e){const{labels:t,colors:o=[],isExpanded:l}=e;if(!t)return a(I,{});const m=l?Math.min(t.length,9):Math.min(t.length,3);if(m===0)return a(I,{});const d=t.reduce((n,y)=>n+y.count,0);return a("div",{className:`FacetNavPanel__body__legend${l?"--expanded":""}`,children:t.slice(0,m).map((n,y)=>{const v=`(${be(n.count/d,1)}) ${n.label}`,u=X(v,Fe);return a(D,{idForToolTip:n.label,tooltipText:n.label,children:C("div",{className:"FacetNavPanel__body__legend__row",style:{cursor:"default"},children:[a("div",{style:{backgroundColor:o[y]}}),a("label",{children:u})]},`legendLabel_${y}`)},n.label)})})}const Te=(e,t)=>e?`FacetNavPanel__body__plot--expanded${t==="BAR"?"Bar":"Pie"}`:"FacetNavPanel__body__plot",B=e=>{const{onHide:t,isModalView:o,applyChangesToFacetFilter:l,applyChangesToGraphSlice:m,index:d,facetToPlot:n,plotType:y,onSetPlotType:N}=e,{accessToken:v}=ae(),{data:u,isLoadingNewBundle:w,getLastQueryRequest:b}=Q(),{facetAliases:x}=z(),[c,T]=W(),[s,p]=W(!1),f=fe(n.columnName,x),_=ge(()=>{var r,g;return(g=(r=u==null?void 0:u.columnModels)==null?void 0:r.find(P=>P.name===n.columnName))==null?void 0:g.columnType},[u,n.columnName]);Se(()=>{let r=!0;if(n)Ee(n,_(),d,y,v).then(g=>{r&&T(g)});else return;return()=>{r=!1}},[n,u,d,y,v,_]);const E=()=>C("div",{onClick:r=>{r.stopPropagation()},className:"bootstrap-4-backport SRC-labeled-dropdown",children:[a("span",{className:"SRC-labeled-dropdown__label",children:"Chart Type"}),C(L,{children:[a(L.Toggle,{className:"secondary-caret",variant:"gray-select",children:y==="PIE"?"Pie Chart":"Bar Chart"}),C(L.Menu,{className:"chart-tools",children:[a(L.Item,{as:"button",onClick:()=>N("BAR"),children:"Bar Chart"}),a(L.Item,{as:"button",onClick:()=>N("PIE"),children:"Pie Chart"})]})]})]});return!u&&w||!n?a("div",{className:"SRC-loadingContainer SRC-centerContentColumn",children:he}):C(I,{children:[C(A,{animation:!1,show:s,onHide:()=>p(!1),backdrop:"static",children:[a(A.Header,{closeButton:!0,children:a(A.Title,{children:f!=null?f:""})}),C(A.Body,{children:[a(B,{...e,isModalView:!0}),a("div",{className:"bootstrap-4-backport SaveFiltersButtonContainer",children:a(j,{variant:"secondary",className:"pill-xl SaveFiltersButton",size:"sm",onClick:()=>p(!1),children:"Apply Filters"})})]})]}),C("div",{role:"graphics-document",className:`FacetNavPanel${o?"--expanded":""}`,children:[!o&&C("div",{className:"FacetNavPanel__title",children:[!u&&w?a(oe,{width:100}):a("span",{className:"FacetNavPanel__title__name",children:f}),C("div",{className:"FacetNavPanel__title__tools",children:[a(G,{facetValues:n.facetValues,columnModel:u==null?void 0:u.columnModels.find(r=>r.name===n.columnName),facetAliases:x,onChange:r=>{U(b(),n,l,r)},onClear:()=>{$(b(),n,l)},containerAs:"Dropdown"}),a(D,{idForToolTip:"expandGraph",tooltipText:"Expand to large graph",callbackFn:()=>p(!0),className:"SRC-primary-color",darkTheme:!1,icon:"expand"},"expandGraph"),a(D,{idForToolTip:"hideGraph",tooltipText:"Hide graph under Show More",callbackFn:()=>t(),className:"SRC-primary-color",darkTheme:!1,icon:"close"},"hideGraph")]})]}),o&&C(I,{children:[C("div",{className:"bootstrap-4-backport SRC-labeled-dropdown",children:[a("span",{className:"SRC-labeled-dropdown__label",children:"Filter All Data By"}),a(G,{facetValues:n.facetValues,columnModel:u==null?void 0:u.columnModels.find(r=>r.name===n.columnName),facetAliases:x,onChange:r=>{U(b(),n,l,r)},onClear:()=>{$(b(),n,l)},containerAs:"Dropdown",dropdownType:"SelectBox"}),a(ye,{title:"Selecting items in this dropdown will affect all facets on the Explore page.",children:a(_e,{className:"SRC-hand-cursor SRC-secondary-text-color"})})]}),a(E,{})]}),C("div",{className:`FacetNavPanel__body${o?"--expanded":""}`,children:[a(pe.SizeMe,{monitorHeight:!0,children:({size:r})=>{var g;return a("div",{className:Te(o,y),children:a(Ce,{layout:ve,data:(g=c==null?void 0:c.data)!=null?g:[],style:xe(r.width,y,o?300:150),config:{displayModeBar:!1},onClick:P=>we(P,n,m)},`${n.columnName}-${y}-${r.width}`)})}}),a(M,{labels:c==null?void 0:c.labels,colors:c==null?void 0:c.colors,isExpanded:o})]})]})]})};try{M.displayName="FacetPlotLegend",M.__docgenInfo={description:"",displayName:"FacetPlotLegend",props:{labels:{defaultValue:null,description:"",name:"labels",required:!1,type:{name:"FacetWithLabel[]"}},colors:{defaultValue:null,description:"",name:"colors",required:!1,type:{name:"string[]"}},isExpanded:{defaultValue:null,description:"",name:"isExpanded",required:!0,type:{name:"boolean"}}}},typeof STORYBOOK_REACT_CLASSES<"u"&&(STORYBOOK_REACT_CLASSES["src/lib/containers/widgets/facet-nav/FacetNavPanel.tsx#FacetPlotLegend"]={docgenInfo:M.__docgenInfo,name:"FacetPlotLegend",path:"src/lib/containers/widgets/facet-nav/FacetNavPanel.tsx#FacetPlotLegend"})}catch{}try{B.displayName="FacetNavPanel",B.__docgenInfo={description:"",displayName:"FacetNavPanel",props:{applyChangesToGraphSlice:{defaultValue:null,description:"",name:"applyChangesToGraphSlice",required:!0,type:{name:"(facet: FacetColumnResultValues, value: FacetColumnResultValueCount | undefined, isSelected: boolean) => void"}},applyChangesToFacetFilter:{defaultValue:null,description:"",name:"applyChangesToFacetFilter",required:!0,type:{name:"(facets: FacetColumnRequest[]) => void"}},index:{defaultValue:null,description:"",name:"index",required:!0,type:{name:"number"}},facetToPlot:{defaultValue:null,description:"",name:"facetToPlot",required:!0,type:{name:"FacetColumnResultValues"}},plotType:{defaultValue:null,description:"",name:"plotType",required:!0,type:{name:"enum",value:[{value:'"PIE"'},{value:'"BAR"'}]}},onSetPlotType:{defaultValue:null,description:"",name:"onSetPlotType",required:!0,type:{name:"(plotType: PlotType) => void"}},onHide:{defaultValue:null,description:"",name:"onHide",required:!0,type:{name:"() => void"}},isModalView:{defaultValue:null,description:"",name:"isModalView",required:!0,type:{name:"boolean"}},onCloseModal:{defaultValue:null,description:"",name:"onCloseModal",required:!1,type:{name:"(() => void)"}}}},typeof STORYBOOK_REACT_CLASSES<"u"&&(STORYBOOK_REACT_CLASSES["src/lib/containers/widgets/facet-nav/FacetNavPanel.tsx#FacetNavPanel"]={docgenInfo:B.__docgenInfo,name:"FacetNavPanel",path:"src/lib/containers/widgets/facet-nav/FacetNavPanel.tsx#FacetNavPanel"})}catch{}const Pe=window.React.useEffect,Ie=window.React.useMemo,K=window.React.useState,k=2;function q(e,t){var l,m;return(m=(l=e==null?void 0:e.facets)==null?void 0:l.filter(d=>d.facetType==="enumeration"&&(!(t!=null&&t.length)||t.indexOf(d.columnName)>-1)&&d.facetValues.length>0&&!ce(d)))!=null?m:[]}const H=({facetsToPlot:e})=>{const{data:t,getLastQueryRequest:o,isLoadingNewBundle:l,executeQueryRequest:m,error:d,asyncJobStatus:n}=Q(),{topLevelControlsState:y}=z(),[N,v]=K([]),[u,w]=K(!0),{showFacetVisualization:b,showFacetFilter:x}=y,c=o();Pe(()=>{const i=q(t,e);i.length!==0&&u&&(v(i.map((h,S)=>({name:h.columnName,isHidden:S>=k,plotType:"PIE"}))),w(!1))},[t,u,e]);const T=i=>{v(h=>h.map((S,F)=>i?{...S,isHidden:!1}:{...S,isHidden:F>=k}))},s=i=>{c.query.selectedFacets=i,c.query.offset=0,m(c)},p=i=>N.find(F=>F.name===i&&F.isHidden===!0)!==void 0,f=Ie(()=>N.find(i=>i.isHidden===!0)?"MORE":N.length<=k?"NONE":"LESS",[N]),_=i=>{g(i,"isHidden",!0)},E=(i,h)=>{g(i,"plotType",h)},r=i=>{var S;const h=(S=N.find(F=>F.name===i))==null?void 0:S.plotType;return h!=null?h:"PIE"},g=(i,h,S)=>{v(F=>F.map(R=>R.name===i?{...R,[h]:S}:R))},P=q(t,e),Z=q(t,e).map((i,h)=>({columnName:i.columnName,colorIndex:h})),J=(c==null?void 0:c.query.selectedFacets)!==void 0&&c.query.selectedFacets.length>0||(c==null?void 0:c.query.additionalFilters)!==void 0&&(c==null?void 0:c.query.additionalFilters.length)>0;return d?a(I,{}):!t&&l?a("div",{className:"SRC-loadingContainer SRC-centerContentColumn",children:(n==null?void 0:n.progressMessage)&&C("div",{children:[a("span",{className:"spinner"}),n.progressMessage]})}):C(I,{children:[a(le,{frontText:"",endText:J?"filtered by":"",hideIfUnfiltered:!0}),P.length>0&&C("div",{className:`FacetNav ${b?"":"hidden"} ${x?se:ie} ${f==="LESS"?"less":""}`,children:[a("div",{className:"FacetNav__row",role:"list",children:P.map(i=>{var h;return a("div",{className:"col-sm-12 col-md-4",style:{display:p(i.columnName)?"none":"block"},children:a(B,{index:(h=Z.find(S=>S.columnName===i.columnName))==null?void 0:h.colorIndex,onHide:()=>_(i.columnName),plotType:r(i.columnName),onSetPlotType:S=>E(i.columnName,S),facetToPlot:i,applyChangesToFacetFilter:s,applyChangesToGraphSlice:(S,F,R)=>$(c,S,s,F==null?void 0:F.value,R),isModalView:!1})},i.columnName)})}),f!=="NONE"&&a("div",{className:"FacetNav__showMoreContainer bootstrap-4-backport",children:a(j,{variant:"secondary",className:"pill-xl FacetNav__showMore",onClick:()=>T(f==="MORE"),style:{zIndex:500},children:f==="LESS"?"Hide Charts":"View All Charts"})})]})]})};try{H.displayName="FacetNav",H.__docgenInfo={description:"",displayName:"FacetNav",props:{facetsToPlot:{defaultValue:null,description:"",name:"facetsToPlot",required:!1,type:{name:"string[]"}}}},typeof STORYBOOK_REACT_CLASSES<"u"&&(STORYBOOK_REACT_CLASSES["src/lib/containers/widgets/facet-nav/FacetNav.tsx#FacetNav"]={docgenInfo:H.__docgenInfo,name:"FacetNav",path:"src/lib/containers/widgets/facet-nav/FacetNav.tsx#FacetNav"})}catch{}export{M as F,O as Q,xe as a,H as b,Ee as e,q as g};
