import{E as ae,a as te}from"./useUserBundle.39ae2965.js";import{d as Y,e as X,S as ne,E as U,h as W,i as D,T as re,j as oe,k as le}from"./TotalQueryResults.f69ff086.js";import{j as a,F as R,a as S}from"./jsx-runtime.2e925369.js";import{b as se}from"./useGetQueryResultBundle.c63f73ed.js";import{c as ie,P as ce}from"./factory.ba5fac56.js";import{r as de}from"./react-sizeme.1795defc.js";import{R as ue}from"./index.es.82d55a6a.js";import{g as pe}from"./ColorGradient.16f0e0f2.js";import{E as Q,u as me}from"./ElementWithTooltip.0c0f75cc.js";import{V as K,A as fe,bJ as he,H as ye}from"./index.584d54bf.js";import{C as A}from"./ColumnType.744125d2.js";import"./assert.57ba3395.js";import{l as _e}from"./LoadingScreen.85210ad1.js";import{M}from"./Modal.739750b1.js";import{B as J}from"./Button.77571428.js";import{I as ge}from"./InfoOutlined.748401db.js";import{D as B}from"./Dropdown.edf6576c.js";const k=()=>{const{error:e}=Y();return a(ae,{error:e})};try{k.displayName="QueryWrapperErrorBanner",k.__docgenInfo={description:"Error banner that automatically pulls the error from QueryContext.",displayName:"QueryWrapperErrorBanner",props:{}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["src/lib/containers/QueryWrapperErrorBanner.tsx#QueryWrapperErrorBanner"]={docgenInfo:k.__docgenInfo,name:"QueryWrapperErrorBanner",path:"src/lib/containers/QueryWrapperErrorBanner.tsx#QueryWrapperErrorBanner"})}catch{}const Se=window.React.useCallback,Ne=window.React.useEffect,z=window.React.useState,Ce=ie(ce),Fe=19,ve=30,be={showlegend:!1,annotations:[],margin:{l:0,r:0,b:0,t:0,pad:0},yaxis:{visible:!1,showgrid:!1},xaxis:{visible:!1,showgrid:!1}},Ee=(e,t)=>{t=t||0;let n=(Math.round(100*e*Math.pow(10,t))*Math.pow(.1,t)).toFixed(t)+"%";for(let o=0;o<t;o++)n.indexOf(".")!==-1&&(n=n.replace("0%","%"),n=n.replace(".%","%"));return n};function Z(e,t){if(!e)return e;const n=e.trim();return n.length>t?n.substr(0,t-1)+"\u2026":e}async function we(e,t,n,o,h){var N,p;const{colorPalette:c}=pe(n,e.facetValues.length),r=async(l,m,C)=>{const f=new Map;f.set(K,fe);const w=l.map(_=>_.value).filter(_=>_!==K);if(m===A.ENTITYID||m===A.ENTITYID_LIST){const _=await he(w,C);for(const i of _.results)f.set(i.id,i.name)}else if(m===A.USERID||m===A.USERID_LIST){const _=await ye(w,C);for(const i of _.children)f.set(i.ownerId,i.userName)}return l.map(_=>({facet:_,label:u(_,!1,f),truncatedLabel:u(_,!0,f),count:_.count}))},u=(l,m,C)=>{var w;let f=(w=C.get(l.value))!=null?w:l.value;return m&&(f=Z(f,Fe)),f},b=await r(e.facetValues,t,h),F=b.map(l=>l.truncatedLabel),T=e.facetValues.some(l=>l.isSelected)?e.facetValues.map((l,m)=>l.isSelected?c[m]:c[m].replace("rgb(","rgba(").replace(")",", 0.25)")):c,E={values:o==="PIE"?e.facetValues.map(l=>l.count):void 0,labels:b.map(l=>l.label),text:F,x:o==="BAR"?e.facetValues.map(l=>{var m,C;return(C=(m=b.find(f=>f.facet===l))==null?void 0:m.label)!=null?C:l.value}):void 0,y:o==="BAR"?e.facetValues.map(l=>l.count):void 0,facetEnumerationValues:e.facetValues.map(l=>l.value),name:e.columnName,hovertemplate:o==="PIE"?"<b>%{text}</b><br>%{value} (%{percent})<br><extra></extra>":"<b>%{text}: </b><br>%{value} <br><extra></extra>",textinfo:"none",type:o==="PIE"?"pie":"bar",pull:o==="PIE"?e.facetValues.map(l=>l.isSelected?.1:0):void 0,marker:{colors:o==="PIE"?T:void 0,color:o==="BAR"?T:void 0}};return{data:[E],labels:b,colors:o==="PIE"?(N=E.marker)==null?void 0:N.colors:(p=E.marker)==null?void 0:p.color}}const Te=(e,t,n)=>{if(e.points&&e.points[0]){const o=e.points[0],h=o.data.facetEnumerationValues[o.pointNumber],c=t.facetValues.find(r=>r.value===h);n(t,c,!c.isSelected)}};function xe(e,t,n){const h=e?e*(t==="BAR"?.8:.6):200;let c=t==="PIE"?h:h/3;return c>n&&(c=n),{width:`${h}px`,height:`${c}px`}}function O(e){const{labels:t,colors:n=[],isExpanded:o}=e;if(!t)return a(R,{});const h=o?Math.min(t.length,9):Math.min(t.length,3);if(h===0)return a(R,{});const c=t.reduce((r,u)=>r+u.count,0);return a("div",{className:`FacetNavPanel__body__legend${o?"--expanded":""}`,children:t.slice(0,h).map((r,u)=>{const F=`(${Ee(r.count/c,1)}) ${r.label}`,d=Z(F,ve);return a(Q,{idForToolTip:r.label,tooltipText:r.label,children:S("div",{className:"FacetNavPanel__body__legend__row",style:{cursor:"default"},children:[a("div",{style:{backgroundColor:n[u]}}),a("label",{children:d})]},`legendLabel_${u}`)},r.label)})})}const Pe=(e,t)=>e?`FacetNavPanel__body__plot--expanded${t==="BAR"?"Bar":"Pie"}`:"FacetNavPanel__body__plot",V=e=>{const{onHide:t,isModalView:n,applyChangesToFacetFilter:o,applyChangesToGraphSlice:h,index:c,facetToPlot:r,plotType:u,onSetPlotType:b}=e,{accessToken:F}=te(),{data:d,isLoadingNewBundle:T,getLastQueryRequest:E}=Y(),{facetAliases:P}=X(),[N,p]=z(),[l,m]=z(!1),C=me(r.columnName,P),f="facet-nav-panel-tooltip",w=Se(()=>{var i,x;return(x=(i=d==null?void 0:d.columnModels)==null?void 0:i.find(I=>I.name===r.columnName))==null?void 0:x.columnType},[d,r.columnName]);Ne(()=>{if(r)we(r,w(),c,u,F).then(i=>p(i));else return},[r,d,c,u,F,w]);const _=()=>S("div",{onClick:i=>{i.stopPropagation()},className:"bootstrap-4-backport SRC-labeled-dropdown",children:[a("span",{className:"SRC-labeled-dropdown__label",children:"Chart Type"}),S(B,{children:[a(B.Toggle,{className:"secondary-caret",variant:"gray-select",children:u==="PIE"?"Pie Chart":"Bar Chart"}),S(B.Menu,{className:"chart-tools",children:[a(B.Item,{as:"button",onClick:()=>b("BAR"),children:"Bar Chart"}),a(B.Item,{as:"button",onClick:()=>b("PIE"),children:"Pie Chart"})]})]})]});return!d&&T||!r?a("div",{className:"SRC-loadingContainer SRC-centerContentColumn",children:_e}):S(R,{children:[S(M,{animation:!1,show:l,onHide:()=>m(!1),backdrop:"static",children:[a(M.Header,{closeButton:!0,children:a(M.Title,{children:C!=null?C:""})}),S(M.Body,{children:[a(V,{...e,isModalView:!0}),a("div",{className:"bootstrap-4-backport SaveFiltersButtonContainer",children:a(J,{variant:"secondary",className:"pill-xl SaveFiltersButton",size:"sm",onClick:()=>m(!1),children:"Apply Filters"})})]})]}),S("div",{role:"graphics-document",className:`FacetNavPanel${n?"--expanded":""}`,children:[!n&&S("div",{className:"FacetNavPanel__title",children:[!d&&T?a(ne,{width:100}):a("span",{className:"FacetNavPanel__title__name",children:C}),S("div",{className:"FacetNavPanel__title__tools",children:[a(U,{facetValues:r.facetValues,columnModel:d==null?void 0:d.columnModels.find(i=>i.name===r.columnName),facetAliases:P,onChange:i=>{W(E(),r,o,i)},onClear:()=>{D(E(),r,o)},containerAs:"Dropdown"}),a(Q,{idForToolTip:"expandGraph",tooltipText:"Expand to large graph",callbackFn:()=>m(!0),className:"SRC-primary-color",darkTheme:!1,icon:"expand"},"expandGraph"),a(Q,{idForToolTip:"hideGraph",tooltipText:"Hide graph under Show More",callbackFn:()=>t(),className:"SRC-primary-color",darkTheme:!1,icon:"close"},"hideGraph")]})]}),n&&S(R,{children:[S("div",{className:"bootstrap-4-backport SRC-labeled-dropdown",children:[a("span",{className:"SRC-labeled-dropdown__label",children:"Filter All Data By"}),a(U,{facetValues:r.facetValues,columnModel:d==null?void 0:d.columnModels.find(i=>i.name===r.columnName),facetAliases:P,onChange:i=>{W(E(),r,o,i)},onClear:()=>{D(E(),r,o)},containerAs:"Dropdown",dropdownType:"SelectBox"}),a(ue,{id:f,effect:"solid",event:"click"}),a(ge,{"data-for":f,"data-tip":"Selecting items in this dropdown will affect all facets on the Explore page.",className:"SRC-hand-cursor SRC-secondary-text-color"})]}),a(_,{})]}),S("div",{className:`FacetNavPanel__body${n?"--expanded":""}`,children:[a(de.SizeMe,{monitorHeight:!0,children:({size:i})=>{var x;return a("div",{className:Pe(n,u),children:a(Ce,{layout:be,data:(x=N==null?void 0:N.data)!=null?x:[],style:xe(i.width,u,n?300:150),config:{displayModeBar:!1},onClick:I=>Te(I,r,h)},`${r.columnName}-${u}-${i.width}`)})}}),a(O,{labels:N==null?void 0:N.labels,colors:N==null?void 0:N.colors,isExpanded:n})]})]})]})};try{O.displayName="FacetPlotLegend",O.__docgenInfo={description:"",displayName:"FacetPlotLegend",props:{labels:{defaultValue:null,description:"",name:"labels",required:!1,type:{name:"FacetWithLabel[]"}},colors:{defaultValue:null,description:"",name:"colors",required:!1,type:{name:"string[]"}},isExpanded:{defaultValue:null,description:"",name:"isExpanded",required:!0,type:{name:"boolean"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["src/lib/containers/widgets/facet-nav/FacetNavPanel.tsx#FacetPlotLegend"]={docgenInfo:O.__docgenInfo,name:"FacetPlotLegend",path:"src/lib/containers/widgets/facet-nav/FacetNavPanel.tsx#FacetPlotLegend"})}catch{}try{V.displayName="FacetNavPanel",V.__docgenInfo={description:"",displayName:"FacetNavPanel",props:{applyChangesToGraphSlice:{defaultValue:null,description:"",name:"applyChangesToGraphSlice",required:!0,type:{name:"(facet: FacetColumnResultValues, value: FacetColumnResultValueCount | undefined, isSelected: boolean) => void"}},applyChangesToFacetFilter:{defaultValue:null,description:"",name:"applyChangesToFacetFilter",required:!0,type:{name:"(facets: FacetColumnRequest[]) => void"}},index:{defaultValue:null,description:"",name:"index",required:!0,type:{name:"number"}},facetToPlot:{defaultValue:null,description:"",name:"facetToPlot",required:!0,type:{name:"FacetColumnResultValues"}},plotType:{defaultValue:null,description:"",name:"plotType",required:!0,type:{name:"enum",value:[{value:'"PIE"'},{value:'"BAR"'}]}},onSetPlotType:{defaultValue:null,description:"",name:"onSetPlotType",required:!0,type:{name:"(plotType: PlotType) => void"}},onHide:{defaultValue:null,description:"",name:"onHide",required:!0,type:{name:"() => void"}},isModalView:{defaultValue:null,description:"",name:"isModalView",required:!0,type:{name:"boolean"}},onCloseModal:{defaultValue:null,description:"",name:"onCloseModal",required:!1,type:{name:"(() => void)"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["src/lib/containers/widgets/facet-nav/FacetNavPanel.tsx#FacetNavPanel"]={docgenInfo:V.__docgenInfo,name:"FacetNavPanel",path:"src/lib/containers/widgets/facet-nav/FacetNavPanel.tsx#FacetNavPanel"})}catch{}const Re=window.React.useEffect,Ie=window.React.useMemo,j=window.React.useState,q=2;function H(e,t){var o,h;return(h=(o=e==null?void 0:e.facets)==null?void 0:o.filter(c=>c.facetType==="enumeration"&&(!(t!=null&&t.length)||t.indexOf(c.columnName)>-1)&&c.facetValues.length>0&&!se(c)))!=null?h:[]}const $=({facetsToPlot:e,showNotch:t=!1})=>{const{data:n,getLastQueryRequest:o,isLoadingNewBundle:h,executeQueryRequest:c,error:r,asyncJobStatus:u}=Y(),{topLevelControlsState:b}=X(),[F,d]=j([]),[T,E]=j(!0),{showFacetVisualization:P,showFacetFilter:N}=b,p=o();Re(()=>{const s=H(n,e);s.length!==0&&T&&(d(s.map((y,g)=>({name:y.columnName,isHidden:g>=q,plotType:"PIE"}))),E(!1))},[n,T,e]);const l=s=>{d(y=>y.map((g,v)=>s?{...g,isHidden:!1}:{...g,isHidden:v>=q}))},m=s=>{p.query.selectedFacets=s,p.query.offset=0,c(p)},C=s=>F.find(v=>v.name===s&&v.isHidden===!0)!==void 0,f=Ie(()=>F.find(s=>s.isHidden===!0)?"MORE":F.length<=q?"NONE":"LESS",[F]),w=s=>{x(s,"isHidden",!0)},_=(s,y)=>{x(s,"plotType",y)},i=s=>{var g;const y=(g=F.find(v=>v.name===s))==null?void 0:g.plotType;return y!=null?y:"PIE"},x=(s,y,g)=>{d(v=>v.map(L=>L.name===s?{...L,[y]:g}:L))},I=(p==null?void 0:p.query.selectedFacets)!==void 0&&p.query.selectedFacets.length>0||(p==null?void 0:p.query.additionalFilters)!==void 0&&(p==null?void 0:p.query.additionalFilters.length)>0,G=H(n,e),ee=H(n,e).map((s,y)=>({columnName:s.columnName,colorIndex:y}));return r?a(R,{}):!n&&h?a("div",{className:"SRC-loadingContainer SRC-centerContentColumn",children:(u==null?void 0:u.progressMessage)&&S("div",{children:[a("span",{className:"spinner"}),u.progressMessage]})}):S(R,{children:[a(re,{frontText:"",endText:I?"Filtered By":"",showNotch:t}),G.length>0&&S("div",{className:`FacetNav ${P?"":"hidden"} ${N?oe:le} ${f==="LESS"?"less":""}`,children:[a("div",{className:"FacetNav__row",role:"list",children:G.map(s=>{var y;return a("div",{className:"col-sm-12 col-md-4",style:{display:C(s.columnName)?"none":"block"},children:a(V,{index:(y=ee.find(g=>g.columnName===s.columnName))==null?void 0:y.colorIndex,onHide:()=>w(s.columnName),plotType:i(s.columnName),onSetPlotType:g=>_(s.columnName,g),facetToPlot:s,applyChangesToFacetFilter:m,applyChangesToGraphSlice:(g,v,L)=>D(p,g,m,v==null?void 0:v.value,L),isModalView:!1})},s.columnName)})}),f!=="NONE"&&a("div",{className:"FacetNav__showMoreContainer bootstrap-4-backport",children:a(J,{variant:"secondary",className:"pill-xl FacetNav__showMore",onClick:()=>l(f==="MORE"),style:{zIndex:500},children:f==="LESS"?"Hide Charts":"View All Charts"})})]})]})};try{$.displayName="FacetNav",$.__docgenInfo={description:"",displayName:"FacetNav",props:{facetsToPlot:{defaultValue:null,description:"",name:"facetsToPlot",required:!1,type:{name:"string[]"}},showNotch:{defaultValue:{value:"false"},description:"",name:"showNotch",required:!1,type:{name:"boolean"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["src/lib/containers/widgets/facet-nav/FacetNav.tsx#FacetNav"]={docgenInfo:$.__docgenInfo,name:"FacetNav",path:"src/lib/containers/widgets/facet-nav/FacetNav.tsx#FacetNav"})}catch{}export{O as F,k as Q,xe as a,$ as b,we as e,H as g};
//# sourceMappingURL=FacetNav.30bc3e25.js.map
