import{W as D,J as v,$ as M,B as U,a0 as q,a1 as F,L as A,a2 as H,a3 as V}from"./index.a11999ac.js";import{U as O}from"./UserCard.95c0756f.js";import{a as u,j as r,F as g}from"./jsx-runtime.2e925369.js";import{b as L,a as W,E as Y}from"./useUserBundle.07091a81.js";import"./assert.5e30d765.js";import{c as $,P as K}from"./factory.c9d66b6e.js";import{p as j}from"./sqlFunctions.9bad0aa7.js";import{S as G}from"./SynapseVideo.0642123b.js";import{u as z}from"./react-intersection-observer.m.66de6abb.js";import{u as J}from"./useInfiniteQuery.0325fb44.js";import{f as Q}from"./DateFormatter.13bb0997.js";import{h as X}from"./moment.81704e1d.js";import{S as Z}from"./SkeletonTable.c6b86b10.js";import{S as ee}from"./Skeleton.bf1489f0.js";import{B as x}from"./Button.77571428.js";const E=window.React;class R extends E.Component{constructor(e){super(e),this.renderBookmarks=this.renderBookmarks.bind(this)}renderBookmarks(){const e=String(this.props.footnotes),t=/Synapse widget&gt;<\/span>(.*)</g;let n;const s=[];for(;n=t.exec(e);)s.push(n[1]);return s.map((i,a)=>{const l=a<s.length-1;return u(E.Fragment,{children:[u("button",{className:"SRC-markdown-bookmark",id:`bookmark${a}`,children:["[",a+1,"]"]}),r("span",{dangerouslySetInnerHTML:{__html:i}}),l&&r("br",{})]},a)})}render(){return u(E.Fragment,{children:[r("hr",{}),this.renderBookmarks()]})}}var te=R;try{R.displayName="Bookmarks",R.__docgenInfo={description:"",displayName:"Bookmarks",props:{footnotes:{defaultValue:null,description:"",name:"footnotes",required:!0,type:{name:"string"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["src/lib/containers/widgets/Bookmarks.tsx#Bookmarks"]={docgenInfo:R.__docgenInfo,name:"Bookmarks",path:"src/lib/containers/widgets/Bookmarks.tsx#Bookmarks"})}catch{}const P=window.React;class I extends P.Component{constructor(e){super(e),this.getEntity=this.getEntity.bind(this),this.getSynapseFiles=this.getSynapseFiles.bind(this),this.state={preSignedURL:""}}getEntity(){const{synapseId:e}=this.props;e&&D(this.context.accessToken,e).then(t=>{const n=[{associateObjectId:e,associateObjectType:v.FileEntity,fileHandleId:t.dataFileHandleId}];this.getSynapseFiles(n,t.dataFileHandleId)})}getSynapseFiles(e,t){M({includeFileHandles:!1,includePreSignedURLs:!0,includePreviewPreSignedURLs:!1,requestedFiles:e},this.context.accessToken).then(s=>{const{preSignedURL:i}=s.requestedFiles.filter(a=>a.fileHandleId===t)[0];this.setState({preSignedURL:i})}).catch(s=>{console.error("Error on getting image ",s)})}componentDidMount(){if(!this.props.wikiId)this.getEntity();else{const{fileName:e,fileResults:t=[]}=this.props,{id:n}=t.filter(i=>i.fileName===e)[0],s=[{associateObjectId:this.props.wikiId,associateObjectType:v.WikiAttachment,fileHandleId:n}];this.getSynapseFiles(s,n)}}render(){const{params:e}=this.props,{align:t="",altText:n="synapse image"}=e;let s="auto";e.scale&&e.scale!=="100"&&(s=`${Number(e.scale)}%`);const i=t.toLowerCase();let a="";i==="left"&&(a="floatLeft"),i==="right"&&(a="floatright"),i==="center"&&(a="align-center");let l={width:s,height:s};return this.state.preSignedURL?r(P.Fragment,{children:r("img",{alt:n,className:"img-fluid  "+a,src:this.state.preSignedURL,style:l})}):null}}I.contextType=L;var B=I;try{I.displayName="SynapseImage",I.__docgenInfo={description:"",displayName:"SynapseImage",props:{wikiId:{defaultValue:null,description:"",name:"wikiId",required:!1,type:{name:"string"}},synapseId:{defaultValue:null,description:"",name:"synapseId",required:!1,type:{name:"string"}},fileName:{defaultValue:null,description:"",name:"fileName",required:!1,type:{name:"string"}},fileResults:{defaultValue:null,description:"",name:"fileResults",required:!1,type:{name:"FileHandle[]"}},params:{defaultValue:null,description:"",name:"params",required:!0,type:{name:"{ align: string; scale: string; responsive: string; altText: string; }"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["src/lib/containers/widgets/SynapseImage.tsx#SynapseImage"]={docgenInfo:I.__docgenInfo,name:"SynapseImage",path:"src/lib/containers/widgets/SynapseImage.tsx#SynapseImage"})}catch{}const ne=window.React,se=$(K);class k extends ne.Component{constructor(e){super(e),this.state={isLoaded:!1,queryData:{}},this.fetchPlotlyData=this.fetchPlotlyData.bind(this),this.showPlot=this.showPlot.bind(this)}componentDidMount(){this.fetchPlotlyData()}fetchPlotlyData(){const{query:e}=this.props.widgetparamsMapped,t={concreteType:"org.sagebionetworks.repo.model.table.QueryBundleRequest",partMask:U,entityId:j(e),query:{sql:e}};q(t,this.context.accessToken).then(n=>{this.setState({isLoaded:!0,queryData:n})}).catch(n=>{console.log("Error on full table query ",n)})}showPlot(){if(!this.state.isLoaded)return;const{title:e,xtitle:t,ytitle:n,type:s,xaxistype:i,showlegend:a}=this.props.widgetparamsMapped,l=this.state,c=this.props.widgetparamsMapped.horizontal.toLowerCase(),d={showlegend:a,title:e};t&&(d.xaxis={title:t}),i&&(d.xaxis={...d.xaxis,xaxistype:i.toLowerCase()}),n&&(d.yaxis={title:n});const p=[],h=c?"v":"h",m=l.queryData.queryResult.queryResults.headers;for(let f=0;f<m.length-1;f+=1)p[f]={orientation:h,name:m[f+1].name,type:s.toLowerCase(),x:[],y:[]};for(const f of l.queryData.queryResult.queryResults.rows)for(let S=1;S<f.values.length;S+=1){const N=f.values;p[S-1].x.push(N[0]),p[S-1].y.push(N[S])}return r(se,{layout:d,data:p})}render(){return this.state.isLoaded?this.showPlot():null}}k.contextType=L;var re=k;try{k.displayName="SynapsePlot",k.__docgenInfo={description:"",displayName:"SynapsePlot",props:{ownerId:{defaultValue:null,description:"",name:"ownerId",required:!1,type:{name:"string"}},wikiId:{defaultValue:null,description:"",name:"wikiId",required:!1,type:{name:"string"}},widgetparamsMapped:{defaultValue:null,description:"",name:"widgetparamsMapped",required:!1,type:{name:"any"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["src/lib/containers/widgets/SynapsePlot.tsx#SynapsePlot"]={docgenInfo:k.__docgenInfo,name:"SynapsePlot",path:"src/lib/containers/widgets/SynapsePlot.tsx#SynapsePlot"})}catch{}function ie(o,e){const{accessToken:t}=W(),n={accessRequirementId:o};return J(["approvedSubmissionInfo",n],async s=>await F({...n,nextPageToken:s.pageParam},t),{...e,getNextPageParam:s=>s.nextPageToken})}const w=({info:o})=>r(g,{children:o&&u("p",{className:"SubmissionInfoCard",children:[r("strong",{children:" Project Lead: "})," ",r("span",{children:o.projectLead})," ",r("br",{}),r("strong",{children:" Institution: "})," ",r("span",{children:o.institution})," ",r("br",{}),r("strong",{children:" Data Access Request Submitted By: "})," ",r(O,{ownerId:o.submittedBy,size:A})," ",r("br",{}),u("strong",{children:[" ","Intended Data Use Statement (accepted on"," ",Q(X(o.modifiedOn),"M/D/YYYY"),"):"]}),r("div",{children:o.intendedDataUseStatement}),o.accessorChanges&&o.accessorChanges.map(e=>u("div",{children:[r(O,{ownerId:e.userId,size:A})," ",e.type]},`${e.userId}-${e.type}`))]})}),_=()=>u("p",{className:"SubmissionInfoCard",children:[r(Z,{numCols:1,numRows:4}),r(ee,{variant:"rect",width:"100%",height:80})]});try{w.displayName="SubmissionInfoCard",w.__docgenInfo={description:"",displayName:"SubmissionInfoCard",props:{info:{defaultValue:null,description:"",name:"info",required:!0,type:{name:"SubmissionInfo"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["src/lib/containers/IDUReportSubmissionInfo.tsx#SubmissionInfoCard"]={docgenInfo:w.__docgenInfo,name:"SubmissionInfoCard",path:"src/lib/containers/IDUReportSubmissionInfo.tsx#SubmissionInfoCard"})}catch{}try{_.displayName="LoadingSubmissionInfoCard",_.__docgenInfo={description:"",displayName:"LoadingSubmissionInfoCard",props:{}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["src/lib/containers/IDUReportSubmissionInfo.tsx#LoadingSubmissionInfoCard"]={docgenInfo:_.__docgenInfo,name:"LoadingSubmissionInfoCard",path:"src/lib/containers/IDUReportSubmissionInfo.tsx#LoadingSubmissionInfoCard"})}catch{}const ae=window.React,oe=window.React.useEffect,T=o=>{var h;const{accessRequirementId:e}=o,{ref:t,inView:n}=z(),{data:s,status:i,isLoading:a,hasNextPage:l,isFetchingNextPage:c,fetchNextPage:d}=ie(e,{useErrorBoundary:!0});oe(()=>{i==="success"&&!c&&l&&d&&n&&d()},[i,l,c,d,n]);const p=(h=s==null?void 0:s.pages.flatMap(m=>m.results))!=null?h:[];return u(g,{children:[p.length>0&&u("div",{className:"IDUReport",children:[p.map(m=>u(ae.Fragment,{children:[r(w,{info:m}),r("hr",{})]},JSON.stringify(m))),r("div",{ref:t})]}),(a||c)&&u(g,{children:[r(_,{}),r(_,{})]})]})};var de=T;try{T.displayName="IDUReport",T.__docgenInfo={description:"",displayName:"IDUReport",props:{accessRequirementId:{defaultValue:null,description:"",name:"accessRequirementId",required:!0,type:{name:"string"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["src/lib/containers/IDUReport.tsx#IDUReport"]={docgenInfo:T.__docgenInfo,name:"IDUReport",path:"src/lib/containers/IDUReport.tsx#IDUReport"})}catch{}const y=window.React,ce={1:"toc-indent1",2:"toc-indent2",3:"toc-indent3",4:"toc-indent4",5:"toc-indent5",6:"toc-indent6"},C=markdownit({html:!0});class b extends y.Component{constructor(e){super(e),markdownitSynapse.init_markdown_it(C,markdownitSub,markdownitSup,markdownitCentertext,markdownitSynapseHeading,markdownitSynapseTable,markdownitStrikethroughAlt,markdownitContainer,markdownitEmphasisAlt,markdownitInlineComments,markdownitBr);const t="";C.use(markdownitSynapse,t,"https://synapse.org").use(markdownitMath,t);const n={};this.props.markdown&&(n.markdown=this.props.markdown),this.state={md:C,error:void 0,fileHandles:void 0,data:n,isLoading:!0},this.markupRef=y.createRef(),this.handleLinkClicks=this.handleLinkClicks.bind(this),this.renderMarkdown=this.renderMarkdown.bind(this),this.recursiveRender=this.recursiveRender.bind(this),this.processMath=this.processMath.bind(this),this.getWikiAttachments=this.getWikiAttachments.bind(this),this.getWikiPageMarkdown=this.getWikiPageMarkdown.bind(this),this.renderWidget=this.renderWidget.bind(this),this.renderSynapseButton=this.renderSynapseButton.bind(this),this.renderSynapseImage=this.renderSynapseImage.bind(this),this.renderVideo=this.renderVideo.bind(this),this.renderSynapsePlot=this.renderSynapsePlot.bind(this),this.renderSynapseTOC=this.renderSynapseTOC.bind(this),this.createHTML=this.createHTML.bind(this),this.addBookmarks=this.addBookmarks.bind(this),this.addIdsToReferenceWidgets=this.addIdsToReferenceWidgets.bind(this),this.addIdsToTocWidgets=this.addIdsToTocWidgets.bind(this)}componentWillUnmount(){this.markupRef.current&&this.markupRef.current.removeEventListener("click",this.handleLinkClicks)}handleLinkClicks(e){const t=e.target;if(t.tagName==="A"||t.tagName==="BUTTON"){const n=e.target;if(n.id.substring(0,3)==="ref"){e.preventDefault();const s=Number(e.currentTarget.id.substring(3)),i=this.markupRef.current.querySelector(`#bookmark${s}`);try{i.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})}catch(a){console.log("error on scroll",a)}}else if(e.currentTarget.id!==null&&n.getAttribute("data-anchor")){e.preventDefault();const s=n.getAttribute("data-anchor"),i=this.markupRef.current.querySelector(`#${s}`);try{i.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})}catch(a){console.log("error on scroll",a)}}}}createHTML(e){if(!e)return{__html:""};const t=this.props.renderInline?this.state.md.renderInline(e):this.state.md.render(e);return{__html:sanitizeHtml(t,{allowedAttributes:{a:["href","target"],button:["class"],div:["class"],h1:["toc"],h2:["toc"],h3:["toc"],h4:["toc"],h5:["toc"],h6:["toc"],li:["class"],ol:["class"],span:["*"],table:["class"],th:["colspan"],thead:["class"],ul:["class"],img:["src","alt"]},allowedTags:["span","code","h1","h2","h3","h4","h5","p","b","i","em","strong","a","id","table","tr","td","tbody","th","thead","button","div","img","image","ol","ul","li","svg","g","br","hr","summary","details","strong"]})}}processMath(){if(!this.markupRef.current)return;const e=this.markupRef.current.querySelectorAll('[id^="mathjax-"]'),t=new RegExp(/\\[()[\]]/,"g");e.forEach(n=>{if(n.textContent&&!n.getAttribute("processed")){n.setAttribute("processed","true");const s=n.textContent.replace(t,"");return katex.render(s,n,{output:"html",throwOnError:!1})}})}addBookmarks(){markdownitSynapse.resetFootnotes(),this.createHTML(this.state.data.markdown);const e=this.createHTML(markdownitSynapse.footnotes()).__html;if(e.length>0)return r(te,{footnotes:e})}async getWikiPageMarkdown(){const{ownerId:e,wikiId:t,objectType:n}=this.props;if(!(!e&&!t))try{const s=await H(this.context.accessToken,e,t,n);try{const i=await this.getWikiAttachments(t||s.id);this.setState({data:s,fileHandles:i,error:void 0})}catch(i){console.error("fileHandlesErr = ",i)}}catch(s){console.error(`Error on wiki markdown load
`,s),this.setState({error:s})}}async getWikiAttachments(e){const{ownerId:t,objectType:n}=this.props;if(!t){console.error("Cannot get wiki attachments without ownerId on Markdown Component");return}return await V(this.context.accessToken,t,e,n).then(s=>s).catch(s=>{console.error("Error on wiki attachment load ",s)})}addIdsToReferenceWidgets(e){const t=/<span id="wikiReference.*?<span data-widgetparams.*?span>/g;let n=1;return e.replace(t,()=>{const s=n;return n+=1,`<a href="" id="ref${s}">[${s}]</a>`})}addIdsToTocWidgets(e){const t="SRC-header-";let n=1;const s=/<h[1-6] toc="true">.*<\/h[1-6]>/gm;return e.replace(s,i=>{const a=n;return n+=1,`${i.substring(0,3)} id="${t}${a}"${i.substring(3)}`})}renderMarkdown(){let e=this.createHTML(this.state.data.markdown).__html;if(e=this.addIdsToReferenceWidgets(e),e=this.addIdsToTocWidgets(e),e.length>0){const n=new DOMParser().parseFromString(e,"text/html");return r(g,{children:this.recursiveRender(n.body,e)})}}recursiveRender(e,t){if(e.nodeType===Node.TEXT_NODE)return u(g,{children:[" ",e.textContent," "]});if(e.nodeType===Node.ELEMENT_NODE&&e instanceof HTMLElement){const n=e.tagName.toLowerCase()==="body"?"span":e.tagName.toLowerCase(),s=e.getAttribute("data-widgetparams");if(s)return this.processHTMLWidgetMapping(s,t);const i=e.attributes,a={};for(let c=0;c<i.length;c++){let d="",p="";const h=i.item(c);h&&(d=h.name,p=h.value),d&&p&&(a[d]=p)}if(e.childNodes.length===0)return y.createElement(n,a);const l=Array.from(e.childNodes).map((c,d)=>r(y.Fragment,{children:this.recursiveRender(c,t)},d));return y.createElement(n,a,r(g,{children:l}))}}decodeXml(e){const t={"&amp;":"&","&gt;":">","&lt;":"<","&quot;":'"'};return e.replace(/(&quot;|&lt;|&gt;|&amp;)/g,(n,s)=>t[s])}processHTMLWidgetMapping(e,t){const n=this.decodeXml(e),s=n.indexOf("?");if(s===-1)return this.renderWidget(n,{},t);const i=n.substring(0,s),a={};return n.substring(s+1).split("&").forEach(l=>{let[c,d]=l.split("=");d=decodeURIComponent(d),a[c]=d}),this.renderWidget(i,a,t)}renderWidget(e,t,n){const s=JSON.stringify(t);switch(t.reactKey=s,e){case"buttonlink":return this.renderSynapseButton(t);case"image":return this.renderSynapseImage(t);case"plot":return this.renderSynapsePlot(t);case"toc":return this.renderSynapseTOC(n);case"badge":return this.renderUserBadge(t);case"iduReport":return this.renderIntendedDataUseReport(t);case"video":case"vimeo":case"youtube":return this.renderVideo(t);default:return}}renderSynapseButton(e){let t="pill-xl ";const{align:n="",highlight:s=""}=e,i=n.toLowerCase();i==="left"&&(t+="floatLeft "),i==="right"&&(t+="floatright ");const a=s==="true"?"secondary":"light-secondary";return i==="center"?r("div",{className:"bootstrap-4-backport",style:{textAlign:"center"},children:r(x,{href:e.url,className:t,variant:a,children:e.text})},e.reactKey):r("span",{className:"bootstrap-4-backport",children:r(x,{href:e.url,className:t,variant:a,children:e.text})})}renderSynapsePlot(e){return r(re,{ownerId:this.props.ownerId,wikiId:this.props.wikiId||this.state.data.id,widgetparamsMapped:e},e.reactKey)}renderVideo(e){return r(G,{params:e})}renderSynapseImage(e){const{reactKey:t}=e;if(e.fileName)return this.state.fileHandles?r(B,{params:e,fileName:e.fileName,wikiId:this.props.wikiId||this.state.data.id,fileResults:this.state.fileHandles.list},t):void 0;if(e.synapseId)return r(B,{params:e,synapseId:e.synapseId},t)}renderSynapseTOC(e){const t=[],n=/<h([1-6]) id="(.*)" .*toc="true">(.*)<\/h[1-6]>/gm;let s="";return e.replace(n,(i,a,l,c)=>(s+=c,t.push(r("div",{children:r("a",{role:"link",className:`link ${ce[Number(a)]}`,"data-anchor":l,children:c})},c)),"")),r("div",{children:t},s)}renderUserBadge(e){return r(O,{size:A,alias:e.alias},JSON.stringify(e))}renderIntendedDataUseReport(e){return r(de,{accessRequirementId:e.accessRestrictionId},JSON.stringify(e))}async componentDidMount(){if(this.state.data.markdown){this.setState({isLoading:!1}),this.props.onMarkdownProcessingDone&&this.props.onMarkdownProcessingDone(this.markupRef.current);return}this.markupRef.current&&this.markupRef.current.addEventListener("click",this.handleLinkClicks),await this.getWikiPageMarkdown(),this.processMath(),this.setState({isLoading:!1}),this.props.onMarkdownProcessingDone&&this.props.onMarkdownProcessingDone(this.markupRef.current)}async componentDidUpdate(e){let t=this.props.ownerId!==e.ownerId;t=t||this.props.wikiId!==e.wikiId,t&&await this.getWikiPageMarkdown(),this.processMath()}render(){const{renderInline:e}=this.props,{isLoading:t,error:n}=this.state;if(n)return r(Y,{error:n});const s=this.addBookmarks(),i=u(g,{children:[t&&r("span",{className:"spinner"}),this.renderMarkdown(),s&&r("div",{children:this.addBookmarks()})]});return e?r("span",{className:"markdown markdown-inline",ref:this.markupRef,children:i}):r("div",{className:"markdown",ref:this.markupRef,children:i})}}b.contextType=L;try{b.displayName="MarkdownSynapse",b.__docgenInfo={description:"Basic Markdown functionality for Synapse, supporting Images/Plots/References/Bookmarks/buttonlinks",displayName:"MarkdownSynapse",props:{ownerId:{defaultValue:null,description:"",name:"ownerId",required:!1,type:{name:"string"}},wikiId:{defaultValue:null,description:"",name:"wikiId",required:!1,type:{name:"string"}},markdown:{defaultValue:null,description:"",name:"markdown",required:!1,type:{name:"string"}},renderInline:{defaultValue:null,description:"",name:"renderInline",required:!1,type:{name:"boolean"}},objectType:{defaultValue:null,description:"",name:"objectType",required:!1,type:{name:"enum",value:[{value:'"ENTITY"'},{value:'"ENTITY_CONTAINER"'},{value:'"PRINCIPAL"'},{value:'"ACTIVITY"'},{value:'"EVALUATION"'},{value:'"SUBMISSION"'},{value:'"EVALUATION_SUBMISSIONS"'},{value:'"FILE"'},{value:'"MESSAGE"'},{value:'"WIKI"'},{value:'"FAVORITE"'},{value:'"ACCESS_REQUIREMENT"'},{value:'"ACCESS_APPROVAL"'},{value:'"TEAM"'},{value:'"TABLE"'},{value:'"ACCESS_CONTROL_LIST"'},{value:'"PROJECT_SETTING"'},{value:'"VERIFICATION_SUBMISSION"'},{value:'"CERTIFIED_USER_PASSING_RECORD"'},{value:'"FORUM"'},{value:'"THREAD"'},{value:'"REPLY"'},{value:'"FORM_GROUP"'},{value:'"FORM_DATA"'},{value:'"ENTITY_VIEW"'},{value:'"USER_PROFILE"'},{value:'"DATA_ACCESS_REQUEST"'},{value:'"DATA_ACCESS_SUBMISSION"'},{value:'"DATA_ACCESS_SUBMISSION_STATUS"'},{value:'"MEMBERSHIP_INVITATION"'}]}},onMarkdownProcessingDone:{defaultValue:null,description:"",name:"onMarkdownProcessingDone",required:!1,type:{name:"((ref: HTMLInputElement | null) => void)"}}}},typeof STORYBOOK_REACT_CLASSES!="undefined"&&(STORYBOOK_REACT_CLASSES["src/lib/containers/MarkdownSynapse.tsx#MarkdownSynapse"]={docgenInfo:b.__docgenInfo,name:"MarkdownSynapse",path:"src/lib/containers/MarkdownSynapse.tsx#MarkdownSynapse"})}catch{}export{b as M};
//# sourceMappingURL=MarkdownSynapse.51b5616b.js.map
